<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>幻の銀水晶 - 星読みAI × マジカルノート術</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Kiwi+Maru:wght@300;400;500&display=swap');
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Kiwi Maru', serif;
            background: linear-gradient(to bottom, #1a0033, #330066, #660099);
            color: #fff;
            min-height: 100vh;
            overflow-x: hidden;
            padding: 10px;
        }
        
        /* キラキラ星のアニメーション */
        @keyframes twinkle {
            0%, 100% { opacity: 0; transform: scale(0.5); }
            50% { opacity: 1; transform: scale(1); }
        }
        
        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-20px); }
        }
        
        @keyframes rainbow {
            0% { filter: hue-rotate(0deg); }
            100% { filter: hue-rotate(360deg); }
        }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        
        @keyframes sparkle {
            0%, 100% { 
                box-shadow: 
                    0 0 10px rgba(255, 192, 203, 0.5),
                    0 0 20px rgba(255, 192, 203, 0.3);
            }
            50% { 
                box-shadow: 
                    0 0 20px rgba(255, 192, 203, 0.8),
                    0 0 40px rgba(255, 192, 203, 0.5),
                    0 0 60px rgba(255, 192, 203, 0.3);
            }
        }
        
        @keyframes moonGlow {
            0%, 100% { 
                text-shadow: 
                    0 0 20px rgba(255, 255, 255, 0.8),
                    0 0 40px rgba(255, 255, 255, 0.5);
            }
            50% { 
                text-shadow: 
                    0 0 30px rgba(255, 255, 255, 1),
                    0 0 60px rgba(255, 255, 255, 0.8),
                    0 0 80px rgba(255, 255, 255, 0.5);
            }
        }
        
        .stars {
            position: fixed;
            width: 100%;
            height: 100%;
            pointer-events: none;
        }
        
        .star {
            position: absolute;
            background: white;
            clip-path: polygon(50% 0%, 61% 35%, 98% 35%, 68% 57%, 79% 91%, 50% 70%, 21% 91%, 32% 57%, 2% 35%, 39% 35%);
            animation: twinkle 3s infinite;
        }
        
        .star:nth-child(odd) { animation-delay: 1s; }
        .star:nth-child(even) { animation-delay: 2s; }
        
        .screen {
            max-width: 400px;
            margin: 20px auto;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 30px;
            padding: 30px;
            border: 2px solid rgba(255, 192, 203, 0.3);
            box-shadow: 0 0 30px rgba(255, 192, 203, 0.3);
            position: relative;
            animation: sparkle 3s infinite;
        }
        
        .magical-title {
            text-align: center;
            font-size: 36px;
            background: linear-gradient(45deg, #ff6ec7, #ffd700, #ff6ec7);
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            animation: rainbow 5s linear infinite;
            margin-bottom: 10px;
            text-shadow: 0 0 30px rgba(255, 192, 203, 0.5);
        }
        
        .subtitle {
            text-align: center;
            font-size: 14px;
            color: #ffb6c1;
            margin-bottom: 30px;
        }
        
        .moon-phase {
            text-align: center;
            font-size: 48px;
            margin: 20px 0;
            animation: float 3s ease-in-out infinite, moonGlow 2s ease-in-out infinite;
        }
        
        .message-box {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            padding: 20px;
            margin: 20px 0;
            border: 1px solid rgba(255, 192, 203, 0.3);
            text-align: center;
            animation: pulse 2s ease-in-out infinite;
        }
        
        .card {
            background: rgba(255, 255, 255, 0.15);
            border-radius: 20px;
            padding: 20px;
            margin: 15px 0;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        .card::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: linear-gradient(45deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            transform: rotate(45deg);
            transition: all 0.5s;
            opacity: 0;
        }
        
        .card:hover::before {
            animation: shine 0.5s ease-in-out;
        }
        
        @keyframes shine {
            0% { transform: translateX(-100%) translateY(-100%) rotate(45deg); opacity: 0; }
            50% { opacity: 1; }
            100% { transform: translateX(100%) translateY(100%) rotate(45deg); opacity: 0; }
        }
        
        .card:hover {
            transform: translateY(-5px) scale(1.05);
            background: rgba(255, 255, 255, 0.25);
            box-shadow: 0 10px 30px rgba(255, 192, 203, 0.5);
        }
        
        .card-icon {
            font-size: 48px;
            margin-bottom: 10px;
            display: inline-block;
            animation: float 4s ease-in-out infinite;
        }
        
        .card:nth-child(odd) .card-icon { animation-delay: 0.5s; }
        .card:nth-child(even) .card-icon { animation-delay: 1s; }
        
        .magical-button {
            background: linear-gradient(135deg, #ff6ec7, #ff9472);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 30px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-block;
            margin: 10px;
            position: relative;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(255, 110, 199, 0.4);
        }
        
        .magical-button::after {
            content: '✨';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 20px;
            opacity: 0;
            transition: all 0.3s ease;
        }
        
        .magical-button:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(255, 110, 199, 0.6);
        }
        
        .magical-button:hover::after {
            opacity: 1;
            transform: translate(-50%, -50%) scale(1.5);
        }
        
        /* フォーム要素 */
        .form-group {
            margin: 20px 0;
        }
        
        .form-group label {
            display: block;
            color: #ffb6c1;
            margin-bottom: 10px;
            font-size: 14px;
        }
        
        .magical-input {
            width: 100%;
            padding: 12px 20px;
            border: 2px solid rgba(255, 192, 203, 0.3);
            border-radius: 20px;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            font-size: 16px;
            transition: all 0.3s ease;
        }
        
        .magical-input:focus {
            outline: none;
            border-color: #ff6ec7;
            box-shadow: 0 0 20px rgba(255, 110, 199, 0.5);
            background: rgba(255, 255, 255, 0.2);
        }
        
        /* 魔法のテキストエリア */
        .magical-textarea {
            width: 100%;
            min-height: 150px;
            padding: 15px;
            border: 2px solid rgba(255, 192, 203, 0.3);
            border-radius: 20px;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            font-size: 16px;
            resize: none;
            transition: all 0.3s ease;
        }
        
        .magical-textarea:focus {
            outline: none;
            border-color: #ff6ec7;
            box-shadow: 0 0 30px rgba(255, 110, 199, 0.5);
            background: rgba(255, 255, 255, 0.2);
        }
        
        /* シンボル選択 */
        .symbol-grid {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin: 20px 0;
        }
        
        .symbol {
            font-size: 40px;
            cursor: pointer;
            transition: all 0.3s ease;
            animation: float 3s ease-in-out infinite;
        }
        
        .symbol:nth-child(1) { animation-delay: 0s; }
        .symbol:nth-child(2) { animation-delay: 0.5s; }
        .symbol:nth-child(3) { animation-delay: 1s; }
        .symbol:nth-child(4) { animation-delay: 1.5s; }
        .symbol:nth-child(5) { animation-delay: 2s; }
        
        .symbol:hover {
            transform: scale(1.3) rotate(360deg);
            filter: drop-shadow(0 0 20px rgba(255, 255, 255, 0.8));
        }
        
        .symbol.selected {
            transform: scale(1.2);
            filter: drop-shadow(0 0 30px rgba(255, 215, 0, 1));
        }
        
        /* カレンダー */
        .calendar {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            padding: 20px;
            margin: 20px 0;
        }
        
        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .calendar-nav {
            background: none;
            border: none;
            color: #ffb6c1;
            font-size: 24px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .calendar-nav:hover {
            transform: scale(1.2);
            color: #ff6ec7;
        }
        
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 5px;
            margin-top: 15px;
        }
        
        .calendar-day {
            aspect-ratio: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.05);
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }
        
        .calendar-day:hover {
            background: rgba(255, 110, 199, 0.3);
            transform: scale(1.1);
        }
        
        .calendar-day.special {
            background: rgba(255, 215, 0, 0.2);
            animation: pulse 2s ease-in-out infinite;
        }
        
        .calendar-day.today {
            background: rgba(255, 110, 199, 0.3);
            border: 2px solid #ff6ec7;
        }
        
        /* 流れ星アニメーション */
        .shooting-star {
            position: fixed;
            width: 2px;
            height: 2px;
            background: white;
            box-shadow: 0 0 10px white;
            animation: shoot 3s linear infinite;
        }
        
        @keyframes shoot {
            0% {
                transform: translateX(0) translateY(0);
                opacity: 1;
            }
            100% {
                transform: translateX(-300px) translateY(300px);
                opacity: 0;
            }
        }
        
        /* ナビゲーション */
        .nav-dots {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin: 30px 0;
        }
        
        .nav-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.3);
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .nav-dot.active {
            background: #ff6ec7;
            box-shadow: 0 0 20px #ff6ec7;
        }
        
        .nav-dot:hover {
            transform: scale(1.3);
            background: #ff9472;
        }

        /* レスポンシブデザイン */
        @media (max-width: 768px) {
            body {
                padding: 0;
            }
            
            .screen {
                max-width: 100%;
                margin: 0;
                border-radius: 0;
                padding: 20px;
                min-height: 100vh;
                box-shadow: none;
            }
            
            .magical-title {
                font-size: 28px;
            }
            
            .subtitle {
                font-size: 12px;
            }
            
            .moon-phase {
                font-size: 36px;
            }
            
            .message-box {
                padding: 15px;
                font-size: 14px;
            }
            
            .card {
                padding: 15px;
                margin: 10px 0;
            }
            
            .card-icon {
                font-size: 36px;
            }
            
            .card h3 {
                font-size: 16px;
            }
            
            .card p {
                font-size: 12px !important;
            }
            
            .magical-button {
                padding: 12px 24px;
                font-size: 14px;
            }
            
            .form-group label {
                font-size: 13px;
            }
            
            .magical-input,
            .magical-textarea {
                font-size: 14px;
                padding: 10px 15px;
            }
            
            .magical-textarea {
                min-height: 120px;
            }
            
            .symbol {
                font-size: 32px;
            }
            
            .symbol-grid {
                gap: 15px;
                flex-wrap: wrap;
            }
            
            .calendar-day {
                font-size: 12px;
            }
            
            .nav-dots {
                margin: 20px 0;
                padding-bottom: 20px;
            }
        }
        
        @media (max-width: 480px) {
            .magical-title {
                font-size: 24px;
            }
            
            .message-box p {
                font-size: 14px !important;
            }
            
            .magical-button {
                width: 100%;
                margin: 5px 0;
            }
            
            .form-group {
                margin: 15px 0;
            }
        }
        
        /* ローディングアニメーション */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: #ff6ec7;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .hidden {
            display: none !important;
        }
        
        /* エラーメッセージ */
        .error-message {
            background: rgba(255, 0, 0, 0.2);
            border: 1px solid rgba(255, 0, 0, 0.5);
            border-radius: 10px;
            padding: 10px;
            margin: 10px 0;
            color: #ffcccc;
            font-size: 14px;
            text-align: center;
        }
        
        /* 成功メッセージ */
        .success-message {
            background: rgba(0, 255, 0, 0.2);
            border: 1px solid rgba(0, 255, 0, 0.5);
            border-radius: 10px;
            padding: 10px;
            margin: 10px 0;
            color: #ccffcc;
            font-size: 14px;
            text-align: center;
        }
    </style>
</head>
<body>
    <!-- 星のアニメーション背景 -->
    <div class="stars" id="stars"></div>
    
    <!-- 流れ星 -->
    <div class="shooting-star" style="top: 20%; right: 10%;"></div>
    <div class="shooting-star" style="top: 50%; right: 30%; animation-delay: 1s;"></div>
    <div class="shooting-star" style="top: 70%; right: 50%; animation-delay: 2s;"></div>
    
    <!-- ホーム画面 -->
    <div class="screen" id="home">
        <h1 class="magical-title">幻の銀水晶</h1>
        <p class="subtitle">星読みAI × マジカルノート術</p>
        
        <div class="moon-phase" id="currentMoonPhase">🌙</div>
        
        <div class="message-box">
            <p style="color: #ffd700; font-size: 18px;" id="todayTitle">星々が見守る夜</p>
            <p style="color: #ffb6c1; margin-top: 10px;" id="todayMessage">「新しい扉を開く勇気を持って。月のエネルギーがあなたの背中を押しています」</p>
        </div>
        
        <div class="card" onclick="showScreen('horoscope')">
            <div class="card-icon">⭐</div>
            <h3>星の流れを読む</h3>
            <p style="font-size: 14px; color: #ffb6c1;">あなたの未来の節目を予測</p>
        </div>
        
        <div class="card" onclick="showScreen('note')">
            <div class="card-icon">📖</div>
            <h3>願いを紡ぐ</h3>
            <p style="font-size: 14px; color: #ffb6c1;">魔法のノートで現実創造</p>
        </div>
        
        <div class="card" onclick="showScreen('calendar')">
            <div class="card-icon">🌛</div>
            <h3>月のリズム</h3>
            <p style="font-size: 14px; color: #ffb6c1;">最適なタイミングを知る</p>
        </div>
        
        <div class="card" onclick="showScreen('message')">
            <div class="card-icon">✨</div>
            <h3>今日のメッセージ</h3>
            <p style="font-size: 14px; color: #ffb6c1;">宇宙からの導きを受け取る</p>
        </div>
        
        <div style="text-align: center; margin-top: 30px;">
            <button class="magical-button" onclick="showScreen('profile')">
                ✨ 星読みの旅を始める
            </button>
        </div>
    </div>
    
    <!-- プロフィール設定画面 -->
    <div class="screen hidden" id="profile">
        <h2 class="magical-title" style="font-size: 28px;">あなたの星の記憶</h2>
        
        <div class="message-box">
            <p style="color: #ffd700;">生まれた瞬間の星空を教えてください</p>
        </div>
        
        <div class="form-group">
            <label>✨ 生年月日</label>
            <input type="date" class="magical-input" id="birthDate">
        </div>
        
        <div class="form-group">
            <label>🌙 出生時間（わかれば）</label>
            <div style="display: flex; gap: 10px;">
                <select class="magical-input" style="flex: 1;" id="birthHour">
                    <option value="">時</option>
                    <option value="0">0時</option>
                    <option value="1">1時</option>
                    <option value="2">2時</option>
                    <option value="3">3時</option>
                    <option value="4">4時</option>
                    <option value="5">5時</option>
                    <option value="6">6時</option>
                    <option value="7">7時</option>
                    <option value="8">8時</option>
                    <option value="9">9時</option>
                    <option value="10">10時</option>
                    <option value="11">11時</option>
                    <option value="12">12時</option>
                    <option value="13">13時</option>
                    <option value="14">14時</option>
                    <option value="15">15時</option>
                    <option value="16">16時</option>
                    <option value="17">17時</option>
                    <option value="18">18時</option>
                    <option value="19">19時</option>
                    <option value="20">20時</option>
                    <option value="21">21時</option>
                    <option value="22">22時</option>
                    <option value="23">23時</option>
                </select>
                <select class="magical-input" style="flex: 1;" id="birthMinute">
                    <option value="">分</option>
                    <option value="0">00分</option>
                    <option value="15">15分</option>
                    <option value="30">30分</option>
                    <option value="45">45分</option>
                </select>
            </div>
        </div>
        
        <div class="form-group">
            <label>🌍 出生地（わかれば）</label>
            <input type="text" class="magical-input" placeholder="東京都渋谷区" id="birthPlace">
        </div>
        
        <div style="text-align: center; margin-top: 30px;">
            <button class="magical-button" onclick="saveProfile()">
                🌙 銀水晶に記憶する
            </button>
        </div>
        
        <div style="text-align: center; margin-top: 10px;">
            <button class="magical-button" onclick="showScreen('home')" style="background: linear-gradient(135deg, #9370db, #ba55d3);">
                戻る
            </button>
        </div>
    </div>
    
    <!-- 星読み画面 -->
    <div class="screen hidden" id="horoscope">
        <h2 class="magical-title" style="font-size: 28px;">星の流れ分析</h2>
        
        <div class="message-box">
            <p style="color: #ffd700; font-size: 16px;">あなたの星座</p>
            <p style="color: white; margin-top: 10px; font-size: 24px;" id="zodiacSign">♈ 牡羊座</p>
        </div>
        
        <div class="card">
            <h3 style="color: #ffd700;">今週の星の流れ</h3>
            <p id="weeklyHoroscope" style="margin-top: 10px; line-height: 1.6;">
                火星があなたの恋愛宮に入り、情熱的なエネルギーが高まります。
                新しい出会いや既存の関係の深まりが期待できる時期です。
            </p>
        </div>
        
        <div class="card">
            <h3 style="color: #ffd700;">重要な転換期</h3>
            <p id="importantDates" style="margin-top: 10px; line-height: 1.6;">
                📅 1月15日：金星と木星のトライン<br>
                📅 1月22日：新月のエネルギー<br>
                📅 2月3日：天王星順行開始
            </p>
        </div>
        
        <div style="text-align: center; margin-top: 30px;">
            <button class="magical-button" onclick="generateDetailedHoroscope()">
                🔮 詳細な星読みを見る
            </button>
        </div>
        
        <div style="text-align: center; margin-top: 10px;">
            <button class="magical-button" onclick="showScreen('home')" style="background: linear-gradient(135deg, #9370db, #ba55d3);">
                戻る
            </button>
        </div>
    </div>
    
    <!-- マジカルノート画面 -->
    <div class="screen hidden" id="note">
        <h2 class="magical-title" style="font-size: 28px;">願いを紡ぐ</h2>
        
        <div class="message-box" style="background: rgba(255, 192, 203, 0.2);">
            <p style="color: #ffd700; font-size: 16px;">✨ AIからの問いかけ ✨</p>
            <p style="color: white; margin-top: 10px; font-size: 18px;" id="aiQuestion">
                「今の星の流れは〈変容〉のエネルギー。<br>
                何を手放し、何を受け入れますか？」
            </p>
        </div>
        
        <div class="form-group">
            <label>💖 あなたの願いと意図</label>
            <textarea class="magical-textarea" placeholder="心に浮かんだことを自由に..." id="noteContent"></textarea>
        </div>
        
        <div class="form-group">
            <label>🌟 象徴を選んでください</label>
            <div class="symbol-grid" id="symbolGrid">
                <span class="symbol" data-symbol="moon">🌙</span>
                <span class="symbol" data-symbol="star">⭐</span>
                <span class="symbol" data-symbol="flower">🌸</span>
                <span class="symbol" data-symbol="crystal">💎</span>
                <span class="symbol" data-symbol="butterfly">🦋</span>
            </div>
        </div>
        
        <div style="text-align: center; margin-top: 30px;">
            <button class="magical-button" onclick="saveNote()">
                🌟 宇宙に願いを送る
            </button>
        </div>
        
        <div style="text-align: center; margin-top: 10px;">
            <button class="magical-button" onclick="showScreen('home')" style="background: linear-gradient(135deg, #9370db, #ba55d3);">
                戻る
            </button>
        </div>
    </div>
    
    <!-- カレンダー画面 -->
    <div class="screen hidden" id="calendar">
        <h2 class="magical-title" style="font-size: 28px;">月のリズム</h2>
        
        <div class="calendar">
            <div class="calendar-header">
                <button class="calendar-nav" onclick="changeMonth(-1)">◀</button>
                <h3 id="currentMonth" style="color: #ffd700;">2025年1月</h3>
                <button class="calendar-nav" onclick="changeMonth(1)">▶</button>
            </div>
            
            <div class="calendar-grid" id="calendarGrid">
                <!-- カレンダーはJSで生成 -->
            </div>
        </div>
        
        <div class="message-box">
            <p style="color: #ffd700;">今日の月相</p>
            <p style="color: white; margin-top: 10px;" id="moonPhaseInfo">🌒 上弦の月 - 行動を起こす時</p>
        </div>
        
        <div style="text-align: center; margin-top: 30px;">
            <button class="magical-button" onclick="showScreen('home')" style="background: linear-gradient(135deg, #9370db, #ba55d3);">
                戻る
            </button>
        </div>
    </div>
    
    <!-- 今日のメッセージ画面 -->
    <div class="screen hidden" id="message">
        <h2 class="magical-title" style="font-size: 28px;">宇宙からの導き</h2>
        
        <div class="moon-phase" style="font-size: 64px;">✨</div>
        
        <div class="message-box" style="background: rgba(255, 215, 0, 0.1); border-color: rgba(255, 215, 0, 0.3);">
            <p style="color: #ffd700; font-size: 20px;" id="dailyTitle">今日のあなたへ</p>
            <p style="color: white; margin-top: 15px; font-size: 18px; line-height: 1.8;" id="dailyMessage">
                「恐れずに新しい一歩を踏み出してください。<br>
                宇宙はあなたの勇気を支え、<br>
                必要なものを必要なタイミングで与えてくれます。」
            </p>
        </div>
        
        <div class="card">
            <h3 style="color: #ffd700;">ラッキーアイテム</h3>
            <p style="margin-top: 10px;" id="luckyItems">
                🌙 ムーンストーン<br>
                🌸 桜の花びら<br>
                💜 紫色のもの
            </p>
        </div>
        
        <div style="text-align: center; margin-top: 30px;">
            <button class="magical-button" onclick="generateNewMessage()">
                🔮 新しいメッセージを受け取る
            </button>
        </div>
        
        <div style="text-align: center; margin-top: 10px;">
            <button class="magical-button" onclick="showScreen('home')" style="background: linear-gradient(135deg, #9370db, #ba55d3);">
                戻る
            </button>
        </div>
    </div>
    
    <script>
        // アプリケーションの状態管理
        const appState = {
            currentScreen: 'home',
            userProfile: null,
            notes: [],
            selectedSymbol: null,
            currentMonth: new Date(),
        };
        
        // ローカルストレージのキー
        const STORAGE_KEYS = {
            PROFILE: 'silverCrystal_profile',
            NOTES: 'silverCrystal_notes',
        };
        
        // 初期化
        function init() {
            createStars();
            loadUserData();
            updateMoonPhase();
            updateTodayMessage();
            setupSymbolSelection();
            
            // 定期的な更新
            setInterval(updateMoonPhase, 60000); // 1分ごと
            setInterval(updateTodayMessage, 3600000); // 1時間ごと
        }
        
        // 星を生成
        function createStars() {
            const starsContainer = document.getElementById('stars');
            for (let i = 0; i < 50; i++) {
                const star = document.createElement('div');
                star.className = 'star';
                star.style.width = Math.random() * 15 + 5 + 'px';
                star.style.height = star.style.width;
                star.style.left = Math.random() * 100 + '%';
                star.style.top = Math.random() * 100 + '%';
                star.style.animationDelay = Math.random() * 3 + 's';
                starsContainer.appendChild(star);
            }
        }
        
        // ユーザーデータを読み込み
        function loadUserData() {
            const profile = localStorage.getItem(STORAGE_KEYS.PROFILE);
            if (profile) {
                appState.userProfile = JSON.parse(profile);
                updateZodiacSign();
            }
            
            const notes = localStorage.getItem(STORAGE_KEYS.NOTES);
            if (notes) {
                appState.notes = JSON.parse(notes);
            }
        }
        
        // 画面遷移
        function showScreen(screenId) {
            // すべての画面を非表示
            document.querySelectorAll('.screen').forEach(screen => {
                screen.classList.add('hidden');
            });
            
            // 指定された画面を表示
            const targetScreen = document.getElementById(screenId);
            if (targetScreen) {
                targetScreen.classList.remove('hidden');
                appState.currentScreen = screenId;
                
                // 画面ごとの初期化処理
                if (screenId === 'calendar') {
                    generateCalendar();
                } else if (screenId === 'horoscope' && appState.userProfile) {
                    updateHoroscope();
                }
            }
        }
        
        // プロフィールを保存
        function saveProfile() {
            const birthDate = document.getElementById('birthDate').value;
            const birthHour = document.getElementById('birthHour').value;
            const birthMinute = document.getElementById('birthMinute').value;
            const birthPlace = document.getElementById('birthPlace').value;
            
            if (!birthDate) {
                showError('生年月日を入力してください');
                return;
            }
            
            appState.userProfile = {
                birthDate,
                birthHour,
                birthMinute,
                birthPlace,
                createdAt: new Date().toISOString()
            };
            
            localStorage.setItem(STORAGE_KEYS.PROFILE, JSON.stringify(appState.userProfile));
            
            updateZodiacSign();
            showSuccess('プロフィールが保存されました✨');
            
            setTimeout(() => {
                showScreen('home');
            }, 1500);
        }
        
        // 星座を更新
        function updateZodiacSign() {
            if (!appState.userProfile || !appState.userProfile.birthDate) return;
            
            const date = new Date(appState.userProfile.birthDate);
            const month = date.getMonth() + 1;
            const day = date.getDate();
            
            const zodiacSign = getZodiacSign(month, day);
            const zodiacElement = document.getElementById('zodiacSign');
            if (zodiacElement) {
                zodiacElement.textContent = `${zodiacSign.symbol} ${zodiacSign.name}`;
            }
        }
        
        // 星座を計算
        function getZodiacSign(month, day) {
            const signs = [
                { name: '山羊座', symbol: '♑', start: [12, 22], end: [1, 19] },
                { name: '水瓶座', symbol: '♒', start: [1, 20], end: [2, 18] },
                { name: '魚座', symbol: '♓', start: [2, 19], end: [3, 20] },
                { name: '牡羊座', symbol: '♈', start: [3, 21], end: [4, 19] },
                { name: '牡牛座', symbol: '♉', start: [4, 20], end: [5, 20] },
                { name: '双子座', symbol: '♊', start: [5, 21], end: [6, 20] },
                { name: '蟹座', symbol: '♋', start: [6, 21], end: [7, 22] },
                { name: '獅子座', symbol: '♌', start: [7, 23], end: [8, 22] },
                { name: '乙女座', symbol: '♍', start: [8, 23], end: [9, 22] },
                { name: '天秤座', symbol: '♎', start: [9, 23], end: [10, 22] },
                { name: '蠍座', symbol: '♏', start: [10, 23], end: [11, 21] },
                { name: '射手座', symbol: '♐', start: [11, 22], end: [12, 21] }
            ];
            
            for (const sign of signs) {
                if ((month === sign.start[0] && day >= sign.start[1]) ||
                    (month === sign.end[0] && day <= sign.end[1])) {
                    return sign;
                }
            }
            
            return signs[0]; // デフォルトは山羊座
        }
        
        // 月相を更新
        function updateMoonPhase() {
            const moonPhases = ['🌑', '🌒', '🌓', '🌔', '🌕', '🌖', '🌗', '🌘'];
            const phaseNames = ['新月', '三日月', '上弦の月', '十三夜月', '満月', '寝待月', '下弦の月', '有明月'];
            
            // 簡易的な月相計算（実際の天文学的計算ではない）
            const now = new Date();
            const year = now.getFullYear();
            const month = now.getMonth();
            const day = now.getDate();
            
            // 2000年1月6日の新月を基準
            const baseNewMoon = new Date(2000, 0, 6);
            const lunarCycle = 29.53058867; // 朔望月
            
            const daysSinceBase = (now - baseNewMoon) / (1000 * 60 * 60 * 24);
            const currentCycle = daysSinceBase / lunarCycle;
            const moonAge = (currentCycle - Math.floor(currentCycle)) * lunarCycle;
            
            const phaseIndex = Math.round(moonAge / lunarCycle * 8) % 8;
            
            document.getElementById('currentMoonPhase').textContent = moonPhases[phaseIndex];
            
            const moonPhaseInfo = document.getElementById('moonPhaseInfo');
            if (moonPhaseInfo) {
                moonPhaseInfo.textContent = `${moonPhases[phaseIndex]} ${phaseNames[phaseIndex]} - ${getMoonPhaseMessage(phaseIndex)}`;
            }
        }
        
        // 月相に応じたメッセージ
        function getMoonPhaseMessage(phaseIndex) {
            const messages = [
                '新しい始まりの時',
                '意図を育む時',
                '行動を起こす時',
                '調整と感謝の時',
                '収穫と達成の時',
                '分かち合いの時',
                '手放しと浄化の時',
                '休息と内省の時'
            ];
            return messages[phaseIndex];
        }
        
        // 今日のメッセージを更新
        function updateTodayMessage() {
            const messages = [
                {
                    title: '星々が見守る夜',
                    message: '新しい扉を開く勇気を持って。月のエネルギーがあなたの背中を押しています'
                },
                {
                    title: '光の道筋',
                    message: '今日は直感を信じて。宇宙からのサインが、あなたを正しい方向へ導きます'
                },
                {
                    title: '魔法の瞬間',
                    message: '小さな奇跡に気づく日。日常の中に隠れた美しさを見つけてください'
                },
                {
                    title: '変容の風',
                    message: '変化を恐れないで。それは成長への大切なステップです'
                },
                {
                    title: '愛の結晶',
                    message: '愛と感謝のエネルギーを送りましょう。それは必ず返ってきます'
                }
            ];
            
            const today = new Date();
            const dayIndex = today.getDate() % messages.length;
            const todayMsg = messages[dayIndex];
            
            document.getElementById('todayTitle').textContent = todayMsg.title;
            document.getElementById('todayMessage').textContent = `「${todayMsg.message}」`;
        }
        
        // シンボル選択の設定
        function setupSymbolSelection() {
            const symbols = document.querySelectorAll('.symbol');
            symbols.forEach(symbol => {
                symbol.addEventListener('click', function() {
                    symbols.forEach(s => s.classList.remove('selected'));
                    this.classList.add('selected');
                    appState.selectedSymbol = this.dataset.symbol;
                });
            });
        }
        
        // ノートを保存
        function saveNote() {
            const content = document.getElementById('noteContent').value;
            if (!content.trim()) {
                showError('願いや意図を入力してください');
                return;
            }
            
            if (!appState.selectedSymbol) {
                showError('象徴を選んでください');
                return;
            }
            
            const note = {
                id: Date.now(),
                content: content,
                symbol: appState.selectedSymbol,
                moonPhase: document.getElementById('currentMoonPhase').textContent,
                createdAt: new Date().toISOString()
            };
            
            appState.notes.push(note);
            localStorage.setItem(STORAGE_KEYS.NOTES, JSON.stringify(appState.notes));
            
            // フォームをクリア
            document.getElementById('noteContent').value = '';
            document.querySelectorAll('.symbol').forEach(s => s.classList.remove('selected'));
            appState.selectedSymbol = null;
            
            showSuccess('願いが宇宙に送られました✨');
            
            // 新しいAIの問いかけを生成
            generateNewAIQuestion();
        }
        
        // 新しいAIの問いかけを生成
        async function generateNewAIQuestion() {
            if (GEMINI_API_KEY !== 'YOUR_GEMINI_API_KEY') {
                const moonPhase = document.getElementById('currentMoonPhase').textContent;
                const prompt = `あなたは幻の銀水晶のマジカルノートAIです。セーラームーンの世界観で、今の月相が${moonPhase}の時のマジカルな問いかけを1つ作ってください。50文字以内で。`;
                
                const result = await callGeminiAPI(prompt);
                if (result) {
                    document.getElementById('aiQuestion').innerHTML = `「${result}」`;
                    return;
                }
            }
            
            // フォールバック
            const questions = [
                '今の星の流れは〈成長〉のエネルギー。どんな種を蒔きますか？',
                '月が教えてくれています。〈解放〉の時。何から自由になりたいですか？',
                '宇宙は〈調和〉を求めています。バランスを取り戻すには？',
                '星たちが〈創造〉を促しています。何を生み出したいですか？',
                '今は〈受容〉のタイミング。受け入れる準備はできていますか？'
            ];
            
            const randomIndex = Math.floor(Math.random() * questions.length);
            document.getElementById('aiQuestion').innerHTML = `「${questions[randomIndex]}」`;
        }
        
        // カレンダーを生成
        function generateCalendar() {
            const year = appState.currentMonth.getFullYear();
            const month = appState.currentMonth.getMonth();
            
            document.getElementById('currentMonth').textContent = `${year}年${month + 1}月`;
            
            const firstDay = new Date(year, month, 1).getDay();
            const lastDate = new Date(year, month + 1, 0).getDate();
            const today = new Date();
            
            const calendarGrid = document.getElementById('calendarGrid');
            calendarGrid.innerHTML = '';
            
            // 曜日ヘッダー
            const weekDays = ['日', '月', '火', '水', '木', '金', '土'];
            weekDays.forEach(day => {
                const dayHeader = document.createElement('div');
                dayHeader.style.textAlign = 'center';
                dayHeader.style.color = '#ffb6c1';
                dayHeader.style.fontSize = '12px';
                dayHeader.textContent = day;
                calendarGrid.appendChild(dayHeader);
            });
            
            // 空白のセル
            for (let i = 0; i < firstDay; i++) {
                const emptyCell = document.createElement('div');
                calendarGrid.appendChild(emptyCell);
            }
            
            // 日付セル
            for (let date = 1; date <= lastDate; date++) {
                const dayCell = document.createElement('div');
                dayCell.className = 'calendar-day';
                dayCell.textContent = date;
                
                // 今日の日付をハイライト
                if (year === today.getFullYear() && 
                    month === today.getMonth() && 
                    date === today.getDate()) {
                    dayCell.classList.add('today');
                }
                
                // 特別な日（新月・満月など）
                if (isSpecialMoonDay(year, month, date)) {
                    dayCell.classList.add('special');
                }
                
                calendarGrid.appendChild(dayCell);
            }
        }
        
        // 月を変更
        function changeMonth(direction) {
            appState.currentMonth.setMonth(appState.currentMonth.getMonth() + direction);
            generateCalendar();
        }
        
        // 特別な月の日かチェック（簡易版）
        function isSpecialMoonDay(year, month, date) {
            // 実際の天文学的計算の代わりに、簡易的なロジック
            const day = new Date(year, month, date).getDate();
            return day === 1 || day === 8 || day === 15 || day === 23;
        }
        
        // ホロスコープを更新
        function updateHoroscope() {
            if (!appState.userProfile) return;
            
            // 簡易的なホロスコープ生成
            const horoscopes = [
                '火星があなたの恋愛宮に入り、情熱的なエネルギーが高まります。新しい出会いや既存の関係の深まりが期待できる時期です。',
                '水星が逆行を終え、コミュニケーションがスムーズになります。延期していた計画を実行に移す良いタイミングです。',
                '金星と木星が調和的な角度を形成し、豊かさと幸運があなたに微笑みます。チャンスを逃さないように。',
                '土星があなたの成長を促しています。困難に見えることも、長期的にはあなたの強さになるでしょう。',
                '海王星の影響で直感力が高まっています。夢やインスピレーションに注意を払ってください。'
            ];
            
            const weeklyIndex = new Date().getDay() % horoscopes.length;
            document.getElementById('weeklyHoroscope').textContent = horoscopes[weeklyIndex];
        }
        
        // Gemini API設定
        const GEMINI_API_KEY = 'YOUR_GEMINI_API_KEY'; // ここにAPIキーを入れる
        const GEMINI_API_URL = 'https://generativelanguage.googleapis.com/v1beta/models/gemini-pro:generateContent';
        
        // Gemini APIを使って星読みを生成
        async function callGeminiAPI(prompt) {
            try {
                const response = await fetch(`${GEMINI_API_URL}?key=${GEMINI_API_KEY}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        contents: [{
                            parts: [{
                                text: prompt
                            }]
                        }]
                    })
                });
                
                if (!response.ok) {
                    throw new Error('API request failed');
                }
                
                const data = await response.json();
                return data.candidates[0].content.parts[0].text;
            } catch (error) {
                console.error('Gemini API Error:', error);
                return null;
            }
        }
        
        // 詳細なホロスコープを生成
        async function generateDetailedHoroscope() {
            showMessage('星読みAIが分析中...');
            
            if (GEMINI_API_KEY === 'YOUR_GEMINI_API_KEY') {
                showError('Gemini APIキーが設定されていません');
                return;
            }
            
            const zodiac = document.getElementById('zodiacSign').textContent;
            const prompt = `あなたは幻の銀水晶の星読みAIです。セーラームーンの世界観で、${zodiac}の今週の詳細な運勢を教えてください。恋愛運、仕事運、金運、健康運、ラッキーアイテムを含めて、希望に満ちた美しい言葉で200文字程度で。`;
            
            const result = await callGeminiAPI(prompt);
            
            if (result) {
                document.getElementById('weeklyHoroscope').textContent = result;
                showSuccess('星読みが完了しました✨');
            } else {
                // オフラインでも使えるようにフォールバック
                const fallbackMessages = [
                    '銀水晶の力により、あなたの道は照らされています。愛と勇気を持って進んでください。',
                    'プリンセス・セレニティがあなたを見守っています。困難も必ず乗り越えられるでしょう。',
                    '月の光があなたの願いを叶えます。信じる心を忘れないでください。'
                ];
                document.getElementById('weeklyHoroscope').textContent = fallbackMessages[Math.floor(Math.random() * fallbackMessages.length)];
                showSuccess('星読みが完了しました✨');
            }
        }
        
        // 新しいメッセージを生成
        async function generateNewMessage() {
            showMessage('宇宙からのメッセージを受信中...');
            
            if (GEMINI_API_KEY !== 'YOUR_GEMINI_API_KEY' && appState.userProfile) {
                const zodiac = getZodiacSign(
                    new Date(appState.userProfile.birthDate).getMonth() + 1,
                    new Date(appState.userProfile.birthDate).getDate()
                );
                
                const prompt = `あなたは幻の銀水晶の守護者です。セーラームーンの世界観で、${zodiac.name}の今日のメッセージを作ってください。希望と愛に満ちた美しい言葉で100文字以内。ラッキーアイテムも3つ提案してください。`;
                
                const result = await callGeminiAPI(prompt);
                if (result) {
                    // メッセージとラッキーアイテムを分離
                    const lines = result.split('\n');
                    const message = lines[0];
                    const items = lines.slice(1).join('\n') || '🌙 ムーンストーン\n⭐ 星のお守り\n💎 クリスタル';
                    
                    document.getElementById('dailyMessage').innerHTML = `「${message}」`;
                    document.getElementById('luckyItems').innerHTML = items;
                    
                    showSuccess('新しいメッセージを受け取りました✨');
                    createSparkleEffect();
                    return;
                }
            }
            
            // フォールバック
            const titles = [
                '宇宙からの愛',
                '星たちの囁き',
                '月の導き',
                '天使のメッセージ',
                '光の祝福'
            ];
            
            const messages = [
                '恐れずに新しい一歩を踏み出してください。宇宙はあなたの勇気を支え、必要なものを必要なタイミングで与えてくれます。',
                'あなたの内なる光を信じてください。その輝きは、周りの人々にも希望を与えます。',
                '今日という日は二度と来ません。この瞬間を大切に、愛を持って生きてください。',
                '困難は成長のチャンスです。宇宙はあなたが乗り越えられる試練しか与えません。',
                '感謝の心を持つことで、さらなる豊かさがあなたの人生に流れ込んできます。'
            ];
            
            const luckyItems = [
                '🌙 ムーンストーン\n🌸 桜の花びら\n💜 紫色のもの',
                '⭐ 星型のアクセサリー\n🌹 赤いバラ\n💎 クリスタル',
                '🦋 蝶のモチーフ\n🌻 ひまわり\n💙 青い石',
                '🌈 虹色のもの\n🍀 四つ葉のクローバー\n💚 エメラルド',
                '✨ キラキラしたもの\n🌺 ハイビスカス\n💛 黄色い花'
            ];
            
            const randomIndex = Math.floor(Math.random() * titles.length);
            
            document.getElementById('dailyTitle').textContent = titles[randomIndex];
            document.getElementById('dailyMessage').innerHTML = `「${messages[randomIndex]}」`;
            document.getElementById('luckyItems').innerHTML = luckyItems[randomIndex];
            
            showSuccess('新しいメッセージを受け取りました✨');
            createSparkleEffect();
        }
        
        // エラーメッセージを表示
        function showError(message) {
            showMessage(message, 'error');
        }
        
        // 成功メッセージを表示
        function showSuccess(message) {
            showMessage(message, 'success');
        }
        
        // メッセージを表示
        function showMessage(message, type = 'info') {
            const messageDiv = document.createElement('div');
            messageDiv.className = type === 'error' ? 'error-message' : 'success-message';
            messageDiv.textContent = message;
            messageDiv.style.position = 'fixed';
            messageDiv.style.top = '20px';
            messageDiv.style.left = '50%';
            messageDiv.style.transform = 'translateX(-50%)';
            messageDiv.style.zIndex = '1000';
            messageDiv.style.maxWidth = '80%';
            
            document.body.appendChild(messageDiv);
            
            setTimeout(() => {
                messageDiv.style.opacity = '0';
                messageDiv.style.transition = 'opacity 0.5s';
                setTimeout(() => {
                    document.body.removeChild(messageDiv);
                }, 500);
            }, 3000);
        }
        
        // キラキラエフェクトを作成
        function createSparkleEffect() {
            for (let i = 0; i < 10; i++) {
                setTimeout(() => {
                    const sparkle = document.createElement('div');
                    sparkle.innerHTML = '✨';
                    sparkle.style.position = 'fixed';
                    sparkle.style.fontSize = '30px';
                    sparkle.style.pointerEvents = 'none';
                    sparkle.style.left = Math.random() * window.innerWidth + 'px';
                    sparkle.style.top = Math.random() * window.innerHeight + 'px';
                    sparkle.style.animation = 'twinkle 2s ease-out';
                    document.body.appendChild(sparkle);
                    
                    setTimeout(() => sparkle.remove(), 2000);
                }, i * 100);
            }
        }
        
        // カーソルに追従するキラキラ
        document.addEventListener('mousemove', (e) => {
            if (Math.random() > 0.98) {
                const sparkle = document.createElement('div');
                sparkle.innerHTML = '✨';
                sparkle.style.position = 'fixed';
                sparkle.style.fontSize = '20px';
                sparkle.style.pointerEvents = 'none';
                sparkle.style.left = e.clientX + 'px';
                sparkle.style.top = e.clientY + 'px';
                sparkle.style.animation = 'twinkle 2s ease-out';
                document.body.appendChild(sparkle);
                
                setTimeout(() => sparkle.remove(), 2000);
            }
        });
        
        // アプリケーションを初期化
        init();
    </script>
</body>
</html>